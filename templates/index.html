<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ•¸å­¸åœ–å½¢ç”Ÿæˆå™¨ (ç„¡æ•µå®¹éŒ¯ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://unpkg.com/function-plot/dist/function-plot.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center py-10">

    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl border border-gray-100 flex flex-col md:flex-row gap-8">
        
        <div class="w-full md:w-1/2 space-y-6">
            <h1 class="text-3xl font-extrabold text-indigo-600 mb-2">ğŸ“ æ•¸å­¸ç¹ªåœ–åŠ©æ‰‹</h1>
            
            <div class="flex border-b border-gray-200">
                <button onclick="switchTab('photo')" id="btn-photo" class="flex-1 py-2 px-4 text-center text-indigo-600 border-b-2 border-indigo-600 font-bold focus:outline-none">ğŸ“¸ æ‹ç…§è¾¨è­˜</button>
                <button onclick="switchTab('manual')" id="btn-manual" class="flex-1 py-2 px-4 text-center text-gray-500 hover:text-indigo-600 font-medium focus:outline-none">âŒ¨ï¸ æ‰‹å‹•è¼¸å…¥</button>
            </div>

            <div id="tab-photo" class="space-y-4">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition">
                    <input type="file" id="imageInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer"/>
                </div>
                
                <div id="previewContainer" class="hidden text-center bg-gray-100 p-2 rounded-lg">
                    <img id="previewImage" class="max-h-40 mx-auto rounded shadow-sm" />
                </div>

                <button onclick="processImage()" id="analyzeBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow transition flex justify-center items-center gap-2">
                    <span>ğŸš€ AI è¾¨è­˜ä¸¦ç¹ªåœ–</span>
                </button>
                <p id="loadingText" class="hidden text-center text-indigo-500 mt-2 font-medium animate-pulse">æ­£åœ¨è©¢å• AI ä¸­...</p>
            </div>

            <div id="tab-manual" class="hidden space-y-4">
                <div>
                    <label class="block text-gray-700 font-bold mb-2">è¼¸å…¥å‡½æ•¸</label>
                    <div class="flex gap-2">
                        <input type="text" id="manualInput" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-lg" placeholder="ä¾‹å¦‚: 2sin(x)" value="1 + 2sin(theta)">
                        <button onclick="manualDraw()" class="bg-green-600 hover:bg-green-700 text-white font-bold px-6 rounded-lg">ç¹ªåœ–</button>
                    </div>
                </div>

                <div class="bg-gray-100 p-3 rounded-lg">
                    <p class="text-xs text-gray-500 mb-2 font-bold">é»æ“Šè¼¸å…¥:</p>
                    <div class="grid grid-cols-5 gap-2">
                        <button onclick="addSymbol('x')" class="bg-white hover:bg-indigo-50 border shadow-sm rounded p-2 font-mono">x</button>
                        <button onclick="addSymbol('theta')" class="bg-yellow-50 hover:bg-yellow-100 border border-yellow-200 shadow-sm rounded p-2 font-serif font-bold text-yellow-700">Î¸</button>
                        <button onclick="addSymbol('PI')" class="bg-white hover:bg-indigo-50 border shadow-sm rounded p-2 font-mono">Ï€</button>
                        <button onclick="addSymbol('^')" class="bg-white hover:bg-indigo-50 border shadow-sm rounded p-2 font-mono">^</button>
                        <button onclick="addSymbol('sin(')" class="bg-blue-50 hover:bg-blue-100 border border-blue-200 shadow-sm rounded p-2 text-xs font-bold">sin</button>
                        <button onclick="addSymbol('cos(')" class="bg-blue-50 hover:bg-blue-100 border border-blue-200 shadow-sm rounded p-2 text-xs font-bold">cos</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full md:w-1/2 bg-gray-50 rounded-xl p-4 border border-gray-200 flex flex-col items-center justify-center min-h-[400px]">
            <h2 class="text-lg font-bold text-gray-800 mb-2 self-start">ğŸ“Š åœ–å½¢é è¦½</h2>
            <div id="latexOutput" class="text-xl text-center text-indigo-600 bg-white px-4 py-2 rounded-lg shadow-sm mb-4 min-h-[3rem] w-full flex items-center justify-center">
                (ç­‰å¾…è¼¸å…¥...)
            </div>
            <div id="plot" class="w-full bg-white border rounded-lg shadow-inner overflow-hidden flex items-center justify-center" style="height: 350px;"></div>
        </div>
    </div>

    <script>
        function switchTab(tab) {
            const photoDiv = document.getElementById('tab-photo');
            const manualDiv = document.getElementById('tab-manual');
            document.getElementById('btn-photo').className = tab === 'photo' ? "flex-1 py-2 px-4 text-center text-indigo-600 border-b-2 border-indigo-600 font-bold" : "flex-1 py-2 px-4 text-center text-gray-500 hover:text-indigo-600 font-medium";
            document.getElementById('btn-manual').className = tab === 'manual' ? "flex-1 py-2 px-4 text-center text-indigo-600 border-b-2 border-indigo-600 font-bold" : "flex-1 py-2 px-4 text-center text-gray-500 hover:text-indigo-600 font-medium";
            
            if(tab === 'photo') { photoDiv.classList.remove('hidden'); manualDiv.classList.add('hidden'); }
            else { photoDiv.classList.add('hidden'); manualDiv.classList.remove('hidden'); }
        }

        function addSymbol(symbol) {
            const input = document.getElementById('manualInput');
            input.value += symbol;
            input.focus();
        }

        // ğŸ”¥ã€é‡é»ä¿®å¾©ã€‘ç„¡æ•µæ¸…æ½”å‡½å¼
        function cleanExpressionForJS(expr) {
            if (!expr) return "";
            let clean = expr;

            // 1. çµ±ä¸€è½‰å°å¯«
            clean = clean.toLowerCase();

            // 2. è™•ç† theta -> x
            clean = clean.replace(/theta/g, 'x');
            clean = clean.replace(/Î¸/g, 'x');
            clean = clean.replace(/pi/g, 'PI');

            // 3. è™•ç† "sin x" (ä¸­é–“æœ‰ç©ºæ ¼) -> "sin(x)"
            clean = clean.replace(/sin\s+x/g, 'sin(x)');
            clean = clean.replace(/cos\s+x/g, 'cos(x)');
            clean = clean.replace(/tan\s+x/g, 'tan(x)');
            
            // 4. è™•ç† "sinx" (æ²’ç©ºæ ¼) -> "sin(x)"
            clean = clean.replace(/sinx/g, 'sin(x)');
            clean = clean.replace(/cosx/g, 'cos(x)');
            clean = clean.replace(/tanx/g, 'tan(x)');

            // 5. ã€æœ€å¼·å¤§æ‹›ã€‘è‡ªå‹•è£œä¹˜è™Ÿï¼šä¾‹å¦‚ "2sin" -> "2*sin", "2x" -> "2*x"
            // é€™è¡Œæ­£è¦è¡¨é”å¼æœƒåœ¨ æ•¸å­— èˆ‡ (å‡½æ•¸æˆ–x) ä¹‹é–“å¼·åˆ¶åŠ  *
            clean = clean.replace(/(\d)\s*(sin|cos|tan|x|\()/g, '$1*$2');

            console.log("åŸå§‹è¼¸å…¥:", expr, "ä¿®æ­£å¾Œ:", clean); // æ–¹ä¾¿é™¤éŒ¯
            return clean;
        }

        function manualDraw() {
            let expression = document.getElementById('manualInput').value;
            // é¡¯ç¤ºæ•¸å­¸å¼
            let displayExpr = expression.replace(/theta/g, "\\theta").replace(/PI/g, "\\pi");
            document.getElementById('latexOutput').innerText = `$$ y = ${displayExpr} $$`;
            MathJax.typesetPromise();
            
            // ç¹ªåœ–
            let plotExpr = cleanExpressionForJS(expression);
            drawGraph(plotExpr);
        }

        const imageInput = document.getElementById('imageInput');
        const previewImage = document.getElementById('previewImage');

        imageInput.onchange = evt => {
            const [file] = imageInput.files;
            if (file) {
                previewImage.src = URL.createObjectURL(file);
                document.getElementById('previewContainer').classList.remove('hidden');
            }
        };

        async function processImage() {
            const file = imageInput.files[0];
            if (!file) return alert("è«‹å…ˆé¸æ“‡ä¸€å¼µç…§ç‰‡ï¼");
            
            const btn = document.getElementById('analyzeBtn');
            const loading = document.getElementById('loadingText');
            btn.disabled = true;
            loading.classList.remove('hidden');

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('/analyze', { method: 'POST', body: formData });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('latexOutput').innerText = `$$${data.latex}$$`;
                    MathJax.typesetPromise();
                    let finalExpr = cleanExpressionForJS(data.graph_fn);
                    drawGraph(finalExpr);
                    document.getElementById('manualInput').value = data.graph_fn;
                } else {
                    alert('ç™¼ç”ŸéŒ¯èª¤: ' + data.error);
                }
            } catch (error) {
                alert('ç¶²è·¯é€£ç·šå¤±æ•—');
            } finally {
                btn.disabled = false;
                loading.classList.add('hidden');
            }
        }

        function drawGraph(expression) {
            try {
                document.getElementById('plot').innerHTML = '';
                functionPlot({
                    target: '#plot',
                    width: document.getElementById('plot').offsetWidth,
                    height: 350,
                    grid: true,
                    data: [{
                        fn: expression,
                        color: '#4f46e5',
                        closed: true
                    }]
                });
            } catch (e) {
                console.error("ç¹ªåœ–å¤±æ•—ï¼ŒåŸå› :", e);
                alert(`ç„¡æ³•ç¹ªåœ–: "${expression}" èªæ³•æœ‰èª¤ã€‚\n\nå»ºè­°ï¼šæª¢æŸ¥æ‹¬è™Ÿæ˜¯å¦å°ç¨±ï¼Ÿè©¦è©¦çœ‹æ‰‹å‹•æ”¹æˆ sin(x)`);
            }
        }
        
        window.onload = manualDraw;
        window.onresize = manualDraw;
    </script>
</body>
</html>